<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WhatsApp Bot Control Panel</title>
    <style>
        :root {
            --bg: #0f172a;
            --fg: #e5e7eb;
            --muted: #94a3b8;
            --accent: #22d3ee;
            --ok: #22c55e;
            --warn: #f59e0b;
            --err: #ef4444;
            --card: #111827;
            --chip: #1f2937;
            --line: #1f2937;
        }

        * { box-sizing: border-box; }
        html, body { margin:0; padding:0; font-family: system-ui, -apple-system, 'Segoe UI', Roboto, sans-serif; background:var(--bg); color:var(--fg); line-height:1.6; }
        .container { max-width:1200px; margin:0 auto; padding:20px; }
        .header { text-align:center; margin-bottom:30px; padding:20px; background:var(--card); border-radius:16px; border:1px solid var(--line); }
        .header h1 { color:var(--accent); margin:0 0 10px 0; font-size:2.5em; }
        .header p { margin:0; font-weight:500; letter-spacing:.5px; color:var(--muted); }

        .status-bar { background:var(--card); border:1px solid var(--line); border-radius:12px; padding:15px; margin-bottom:20px; display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:10px; }
        .status-item { display:flex; align-items:center; gap:8px; }
        .status-dot { width:10px; height:10px; border-radius:50%; background:var(--err); }
        .status-dot.ok { background:var(--ok); }

        .main-content { display:grid; grid-template-columns:1fr 1fr; gap:20px; margin-bottom:20px; }
        @media (max-width:768px){ .main-content { grid-template-columns:1fr; } }

        .card { background:var(--card); border:1px solid var(--line); border-radius:16px; padding:20px; }
        .card h2 { margin:0 0 15px 0; color:var(--accent); font-size:1.3em; }

        .form-group { margin-bottom:15px; }
        .form-group label { display:block; margin-bottom:5px; font-weight:600; color:var(--fg); }
        .form-group input, .form-group textarea, .form-group select { width:100%; padding:12px; border:1px solid var(--line); border-radius:8px; background:var(--bg); color:var(--fg); font-size:14px; }
        .form-group input:focus, .form-group textarea:focus, .form-group select:focus { outline:none; border-color:var(--accent); box-shadow:0 0 0 2px rgba(34,211,238,.2); }
        .form-group textarea { min-height:100px; resize:vertical; }

        .btn { background:var(--accent); color:#000; border:none; padding:12px 24px; border-radius:8px; font-size:14px; font-weight:600; cursor:pointer; transition:.2s; width:100%; }
        .btn:hover { background:#1dd1f0; transform:translateY(-1px); }
        .btn:disabled { background:var(--muted); cursor:not-allowed; transform:none; }

        .output { background:var(--card); border:1px solid var(--line); border-radius:16px; padding:20px; margin-top:20px; }
        .output h3 { margin:0 0 15px 0; color:var(--accent); }
        .output-content { background:#0b1220; border:1px solid var(--line); border-radius:8px; padding:15px; min-height:200px; max-height:400px; overflow-y:auto; font-family:'Courier New',monospace; font-size:13px; white-space:pre-wrap; }
        .output-content span { display:block; margin:0 0 4px 0; }

        .loading { display:none; text-align:center; padding:20px; color:var(--muted); }
        .spinner { display:inline-block; width:20px; height:20px; border:2px solid var(--muted); border-radius:50%; border-top-color:var(--accent); animation:spin 1s ease-in-out infinite; }
        @keyframes spin { to { transform:rotate(360deg); } }

        .success { color:var(--ok); } .error { color:var(--err); } .info { color:var(--accent); }

        .type-selector { display:flex; gap:10px; margin-bottom:15px; }
        .type-btn { flex:1; padding:8px 16px; background:var(--chip); color:var(--fg); border:1px solid var(--line); border-radius:6px; cursor:pointer; text-align:center; transition:.2s; }
        .type-btn.active { background:var(--accent); color:#000; }

        .chip-box { background:var(--chip); padding:10px; border-radius:8px; border:1px solid var(--line); }
        .metrics-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:15px; }

        .controls-grid { display:grid; gap:15px; }
        .job-actions { display:flex; flex-wrap:wrap; gap:8px; }
        .mini-btn { flex:1; min-width:110px; background:var(--chip); color:var(--fg); border:1px solid var(--line); border-radius:8px; padding:10px 12px; font-size:12px; cursor:pointer; font-weight:600; transition:.15s; }
        .mini-btn:hover { background:var(--accent); color:#000; }
        .mini-btn.danger { background:#3b1f25; border-color:#7f1d1d; }
        .mini-btn.danger:hover { background:var(--err); color:#fff; }
        .mini-btn.ok { background:#1e3a29; border-color:#14532d; }
        .mini-btn.ok:hover { background:var(--ok); color:#000; }
        .inline-field { display:flex; gap:10px; align-items:center; }
        .inline-field input { flex:1; }
        .badge-link { text-decoration:none; background:var(--chip); padding:6px 12px; border:1px solid var(--line); border-radius:8px; font-size:12px; font-weight:600; color:var(--accent); }
        .badge-link:hover { background:var(--accent); color:#000; }
        .recent-jobs { display:flex; gap:6px; flex-wrap:wrap; margin-top:8px; }
        .recent-jobs button { background:#253042; border:1px solid var(--line); color:var(--fg); font-size:11px; padding:5px 9px; border-radius:8px; cursor:pointer; transition:.15s; }
        .recent-jobs button:hover { background:var(--accent); color:#000; }
        .recent-jobs button.active { background:var(--accent); color:#000; box-shadow:0 0 0 2px rgba(34,211,238,.25); }

        /* Dark theme friendly scrollbar */
        html, body, .output-content, .metrics-grid, .card { scrollbar-color:#374151 var(--card); scrollbar-width:thin; }
        ::-webkit-scrollbar { width:10px; }
        ::-webkit-scrollbar-track { background:var(--card); border-radius:8px; }
        ::-webkit-scrollbar-thumb { background:#374151; border-radius:8px; border:2px solid var(--card); }
        ::-webkit-scrollbar-thumb:hover { background:#4b5563; }
        ::-webkit-scrollbar-corner { background:var(--card); }

        /* API controls layout */
        .api-card { margin-bottom:20px; }
        .api-header { display:flex; align-items:center; justify-content:space-between; gap:16px; flex-wrap:wrap; }
        .api-title { font-size:1.3em; margin:0; color:var(--accent); display:flex; align-items:center; gap:8px; }
        .api-input-row { display:flex; gap:12px; width:100%; flex-wrap:wrap; }
        .api-input-wrapper { flex:1 1 320px; position:relative; }
        .api-input-wrapper input { width:100%; padding:14px 16px; background:var(--chip); border:1px solid var(--line); border-radius:10px; color:var(--fg); font-size:14px; font-family:inherit; transition:.18s; }
        .api-input-wrapper input:focus { outline:none; border-color:var(--accent); box-shadow:0 0 0 2px rgba(34,211,238,.15); }
        .api-input-wrapper input::placeholder { color:var(--muted); }
        .api-doc-link { padding:14px 18px; background:var(--chip); border:1px solid var(--line); border-radius:10px; color:var(--accent); font-weight:600; font-size:13px; text-decoration:none; display:inline-flex; align-items:center; gap:6px; transition:.18s; }
        .api-doc-link:hover { background:var(--accent); color:#000; }
        .api-actions { display:grid; gap:10px; margin-top:14px; grid-template-columns:repeat(auto-fit,minmax(140px,1fr)); }
        .api-btn { background:var(--chip); border:1px solid var(--line); color:var(--fg); padding:12px 14px; font-size:13px; font-weight:600; border-radius:10px; cursor:pointer; transition:.18s; letter-spacing:.2px; }
        .api-btn:hover { background:var(--accent); color:#000; }
        .api-btn.danger { background:#381f25; border-color:#7f1d1d; }
        .api-btn.danger:hover { background:var(--err); color:#fff; }
        .api-btn.ok { background:#1e3a29; border-color:#14532d; }
        .api-btn.ok:hover { background:var(--ok); color:#000; }
        .recent-jobs { display:flex; gap:6px; flex-wrap:wrap; margin-top:10px; }
        .recent-jobs button { background:#253042; border:1px solid var(--line); color:var(--fg); font-size:11px; padding:5px 9px; border-radius:8px; cursor:pointer; transition:.15s; }
        .recent-jobs button:hover { background:var(--accent); color:#000; }
        .api-hint { margin-top:10px; color:var(--muted); font-size:12px; }
        @media (max-width:640px){ .api-input-row{flex-direction:column;} .api-doc-link{width:100%; justify-content:center;} }

        .job-json-view { margin-top:12px; background:var(--chip); border:1px solid var(--line); border-radius:10px; padding:12px; font-family:"Courier New",monospace; font-size:12px; line-height:1.35; max-height:260px; overflow:auto; white-space:pre; position:relative; }
        .job-json-tools { position:absolute; top:6px; right:8px; display:flex; gap:6px; }
        .jj-btn { background:#253042; border:1px solid var(--line); color:var(--accent); font-size:11px; padding:4px 8px; border-radius:6px; cursor:pointer; }
        .jj-btn:hover { background:var(--accent); color:#000; }
        .job-json-collapsed { cursor:pointer; opacity:.7; }
        .hidden { display:none; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ü§ñ WhatsApp Bot</h1>
            <p>Message Dispatch & Job Monitoring Panel</p>
        </div>
        <div class="card api-card" id="api-controls">
            <div class="api-header">
                <h2 class="api-title">üõ†Ô∏è API Controls</h2>
            </div>
            <div class="api-input-row">
                <div class="api-input-wrapper">
                    <input id="job-id-input" type="text" placeholder="Job ID (e.g. req_2025...)" autocomplete="off" />
                </div>
                <a href="/docs" target="_blank" class="api-doc-link" title="Open API Documentation">API Docs ‚Üó</a>
            </div>
            <div class="recent-jobs" id="recent-jobs"></div>
            <div id="job-json-wrapper" class="job-json-view hidden">
                <div class="job-json-tools">
                    <button id="job-json-collapse" class="jj-btn" title="Hide / Show">Hide</button>
                    <button id="job-json-copy" class="jj-btn" title="Copy JSON">Copy</button>
                </div>
                <code id="job-json-code">{}</code>
            </div>
            <div class="api-actions">
                <button class="api-btn" data-action="status">Status</button>
                <button class="api-btn" data-action="pause">Pause</button>
                <button class="api-btn" data-action="resume">Resume</button>
                <button class="api-btn danger" data-action="cancel">Cancel</button>
                <button class="api-btn" data-action="retry">Retry</button>
                <button class="api-btn ok" data-action="recover" title="Recover stalled jobs (/recover)">Bulk Recover</button>
            </div>
            <div class="api-hint">Newly created job IDs appear above (session only).</div>
        </div>
        <div class="status-bar">
            <div class="status-item">
                <div class="status-dot" id="wa-status"></div>
                <span id="wa-status-text">WhatsApp: Connecting...</span>
            </div>
            <div class="status-item"><span id="profiles-status">Profiles: 0/0</span></div>
            <div class="status-item"><span id="jobs-status">Jobs: Loading...</span></div>
        </div>
        <div class="main-content">
            <div class="card">
                <h2>üì± Send Message</h2>
                <div class="type-selector">
                    <div class="type-btn active" data-type="single">Single Number</div>
                    <div class="type-btn" data-type="multiple">Multiple Numbers</div>
                    <div class="type-btn" data-type="group">Group</div>
                </div>
                <form id="message-form">
                    <div class="form-group">
                        <label for="target" id="target-label">Phone Number:</label>
                        <input type="text" id="target" placeholder="+905551234567" required>
                        <small id="target-help" style="color: var(--muted); font-size: 12px;">Single number: +905551234567</small>
                    </div>
                    <div class="form-group">
                        <label for="message">Message:</label>
                        <textarea id="message" placeholder="Type your message here..." required></textarea>
                    </div>
                    <button type="submit" class="btn" id="send-btn">
                        <span id="send-text">Send Message</span>
                        <div class="spinner" id="send-spinner" style="display:none;"></div>
                    </button>
                </form>
            </div>
            <div class="card">
                <h2>üìä System Status</h2>
                <div id="system-metrics"><div class="loading"><div class="spinner"></div><p>Loading system status...</p></div></div>
            </div>
        </div>
        <div class="output">
            <h3>üìã Output & Logs</h3>
            <div class="output-content" id="output"></div>
        </div>
    </div>
    <script>
        // Interface fully in English & minimal professional tweaks
        const API_BASE = window.location.origin;
        let currentJobId = null;
        let statusCheckInterval = null;

        // UI Elements
        const waStatus = document.getElementById('wa-status');
        const waStatusText = document.getElementById('wa-status-text');
        const profilesStatus = document.getElementById('profiles-status');
        const jobsStatus = document.getElementById('jobs-status');
        const systemMetrics = document.getElementById('system-metrics');
        const output = document.getElementById('output');
        const messageForm = document.getElementById('message-form');
        const sendBtn = document.getElementById('send-btn');
        const sendText = document.getElementById('send-text');
        const sendSpinner = document.getElementById('send-spinner');
        const targetInput = document.getElementById('target');
        const targetLabel = document.getElementById('target-label');
        const targetHelp = document.getElementById('target-help');
        const messageInput = document.getElementById('message');

        // Type selector
        const typeButtons = document.querySelectorAll('.type-btn');
        let currentType = 'single';

        document.addEventListener('DOMContentLoaded', function() {
            setupTypeSelectors();
            try { recentJobs = JSON.parse(localStorage.getItem('recent_jobs')||'[]'); } catch(e){ recentJobs=[]; }
            renderRecentJobs();
            loadMetrics();
            setInterval(loadMetrics, 3000);
            addToOutput('üöÄ WhatsApp Bot UI initialized', 'info');
        });

        function setupTypeSelectors() {
            typeButtons.forEach(btn => {
                btn.addEventListener('click', function() {
                    typeButtons.forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    currentType = this.dataset.type;
                    updatePlaceholders();
                });
            });
        }

        function updatePlaceholders() {
            switch(currentType) {
                case 'single':
                    targetLabel.textContent = 'Phone Number:';
                    targetInput.placeholder = '+905551234567';
                    targetHelp.textContent = 'Single number: +905551234567';
                    break;
                case 'multiple':
                    targetLabel.textContent = 'Phone Numbers (comma separated):';
                    targetInput.placeholder = '+905551234567,+905557654321';
                    targetHelp.textContent = 'Multiple numbers separated by comma';
                    break;
                case 'group':
                    targetLabel.textContent = 'Group Name:';
                    targetInput.placeholder = 'Friends';
                    targetHelp.textContent = 'Exact WhatsApp group name';
                    break;
            }
        }

        async function loadMetrics() {
            try {
                const response = await fetch(`${API_BASE}/metrics`);
                const data = await response.json();
                if (data.wa_ready) { waStatus.classList.add('ok'); waStatusText.textContent = 'WhatsApp: Connected ‚úì'; }
                else { waStatus.classList.remove('ok'); waStatusText.textContent = 'WhatsApp: Connecting...'; }
                profilesStatus.textContent = `Profiles: ${data.prof_ready}/${data.prof_total}`;
                jobsStatus.textContent = `Jobs: ${data.queued_jobs} queued, ${data.running_jobs} running`;
                updateSystemMetrics(data);
            } catch (error) {
                console.error('Error loading metrics:', error);
                addToOutput(`‚ùå Could not fetch system status: ${error.message}`, 'error');
            }
        }

        function updateSystemMetrics(data) {
            const boxes = [
                {title:'WhatsApp Status', value: data.wa_ready ? '‚úì Connected' : '‚è≥ Connecting', color: data.wa_ready ? 'var(--ok)' : 'var(--err)'},
                {title:'Profiles', value: `${data.prof_ready}/${data.prof_total} ready`},
                {title:'Queued Jobs', value: `${data.queued_jobs} jobs`},
                {title:'Running Jobs', value: `${data.running_jobs} jobs`},
            ];
            const metricsHtml = `<div class="metrics-grid">${boxes.map(b => `\n                <div class=\"chip-box\">\n                    <div style=\"color: var(--accent); font-weight:600;\">${b.title}</div>\n                    <div style=\"color:${b.color || 'var(--fg)'}; font-weight:500;\">${b.value}</div>\n                </div>`).join('')}\n            </div>`;
            systemMetrics.innerHTML = metricsHtml;
        }

        function normalizeTarget(raw, type){
            if(!raw) return '';
            if(type === 'group') return raw.trim();
            const clean = n => n.trim().replace(/^\+/, '').replace(/[\s-]/g, '');
            if(type === 'multiple') return raw.split(',').map(clean).filter(Boolean).join(',');
            return clean(raw);
        }

        messageForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            const rawTarget = targetInput.value.trim();
            const normalizedTarget = normalizeTarget(rawTarget, currentType);
            const message = messageInput.value.trim();
            if (!normalizedTarget || !message) { addToOutput('‚ùå Please fill in all fields', 'error'); return; }
            if(rawTarget !== normalizedTarget) { addToOutput(`üîß Normalized: ${rawTarget} -> ${normalizedTarget}`, 'info'); }
            sendBtn.disabled = true; sendText.style.display = 'none'; sendSpinner.style.display = 'inline-block';
            try {
                const encodedMessage = encodeURIComponent(message);
                const url = `${API_BASE}/send/${normalizedTarget}/${encodedMessage}`;
                addToOutput(`üì§ Sending message: ${normalizedTarget}`, 'info');
                addToOutput(`üí¨ Message: ${message}`, 'info');
                const response = await fetch(url);
                const data = await response.json();
                if (response.ok) {
                    currentJobId = data.request_id;
                    rememberJob(currentJobId);
                    addToOutput(`‚úÖ Message job created: ${data.request_id}`, 'success');
                    addToOutput(`üìä ${data.accepted} accepted, ${data.queued} queued`, 'info');
                    controlJob('status', currentJobId);
                    startStatusCheck(currentJobId);
                } else { addToOutput(`‚ùå Error: ${data.error || 'Unknown error'}`, 'error'); }
            } catch (error) { addToOutput(`‚ùå Connection error: ${error.message}`, 'error'); }
            finally { sendBtn.disabled = false; sendText.style.display = 'inline'; sendSpinner.style.display = 'none'; }
        });

        function startStatusCheck(jobId) {
            if (statusCheckInterval) { clearInterval(statusCheckInterval); }
            statusCheckInterval = setInterval(async () => {
                try {
                    const response = await fetch(`${API_BASE}/status/${jobId}`);
                    const data = await response.json();
                    if (response.ok) {
                        updateJobStatus(data);
                        if (['done', 'failed', 'canceled'].includes(data.status)) { clearInterval(statusCheckInterval); statusCheckInterval = null; }
                    }
                } catch (error) { console.error('Status check error:', error); }
            }, 2000);
        }

        function updateJobStatus(jobData) {
            const statusIcon = { queued:'‚è≥', running:'üîÑ', done:'‚úÖ', failed:'‚ùå', canceled:'üö´', paused:'‚è∏Ô∏è' };
            const icon = statusIcon[jobData.status] || 'üìã';
            addToOutput(`${icon} Job status: ${jobData.status.toUpperCase()}`, 'info');
            if (jobData.targets && jobData.targets.length > 0) {
                jobData.targets.forEach(target => {
                    const targetIcon = { sent:'‚úÖ', failed:'‚ùå', pending:'‚è≥', running:'üîÑ' };
                    const tIcon = targetIcon[target.status] || 'üì±';
                    addToOutput(`  ${tIcon} ${target.phone}: ${target.status}`, 'info');
                    if (target.error) { addToOutput(`    ‚ùå Error: ${target.error}`, 'error'); }
                });
            }
            if (jobData.timeline && jobData.timeline.length > 0) {
                const lastEvent = jobData.timeline[jobData.timeline.length - 1];
                addToOutput(`üìã Last event: ${lastEvent.event} - ${lastEvent.detail}`, 'info');
            }
        }

        function addToOutput(message, type = 'info') {
            // Timestamp format: dd:mm:yyyy HH:MM:SS (requested)
            const timestamp = (function(){
                const d = new Date();
                const pad = n => String(n).padStart(2,'0');
                return `${pad(d.getDate())}:${pad(d.getMonth()+1)}:${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
            })();
            const line = `[${timestamp}] ${message}\n`;
            output.insertAdjacentHTML('afterbegin', `<span class="${type}">${line}</span>`);
            output.scrollTop = 0;
        }

        // API Controls logic
        const jobIdInput = document.getElementById('job-id-input');
        const recentJobsBox = document.getElementById('recent-jobs');
        const actionButtons = document.querySelectorAll('[data-action]');
        let recentJobs = [];
        let selectedJobId = null;

        function rememberJob(id){
            if(!id || !/^req_/.test(id)) return;
            recentJobs = recentJobs.filter(j=>j!==id);
            recentJobs.unshift(id);
            if(recentJobs.length>10) recentJobs = recentJobs.slice(0,10);
            localStorage.setItem('recent_jobs', JSON.stringify(recentJobs));
            renderRecentJobs();
        }
        function renderRecentJobs(){
            recentJobsBox.innerHTML = recentJobs.map(j=>`<button type="button" data-jid="${j}" class="${j===selectedJobId?'active':''}">${j}</button>`).join('');
            recentJobsBox.querySelectorAll('button').forEach(btn=>{
                btn.addEventListener('click',()=>{
                    const id = btn.dataset.jid;
                    selectedJobId = id;
                    controlJob('status', id);
                    renderRecentJobs();
                    addToOutput(`üîñ Selected: ${id}`,'info');
                });
            });
        }

        actionButtons.forEach(b=>{
            b.addEventListener('click',()=>{
                const act = b.dataset.action;
                if(act === 'recover') { return recoverAll(); }
                const id = jobIdInput.value.trim();
                if(!id){ addToOutput('‚ùå Enter Job ID','error'); return; }
                controlJob(act, id);
            });
        });

        async function controlJob(action, id){
            let path;
            switch(action){
                case 'status': path = `/status/${id}`; break;
                case 'pause': path = `/pause/${id}`; break;
                case 'resume': path = `/resume/${id}`; break;
                case 'cancel': path = `/cancel/${id}`; break;
                case 'retry': path = `/retry/${id}`; break;
                default: return;
            }
            try {
                addToOutput(`üîó ${action.toUpperCase()} request: ${id}`, 'info');
                const res = await fetch(API_BASE + path);
                const data = await res.json();
                if(!res.ok){ addToOutput(`‚ùå Error: ${data.error||'unknown'}`,'error'); return; }
                if(action==='status') { addToOutput(`üìÑ Status: ${data.status} (${data.id})`,'info'); showJobDetails(data); }
                else { addToOutput(`‚úÖ ${action.toUpperCase()} applied: ${data.status}`,'success'); showJobDetails(data); }
                showRawJob(data);
                if(data.id) { rememberJob(data.id); selectedJobId = data.id; renderRecentJobs(); }
            } catch(e){ addToOutput(`‚ùå Network error (${action}): ${e.message}`,'error'); }
        }

        async function recoverAll(){
            try {
                addToOutput('üß™ Bulk recovery started (/recover)','info');
                const res = await fetch(API_BASE + '/recover');
                const data = await res.json();
                if(!res.ok){ addToOutput(`‚ùå Error: ${data.error||'unknown'}`,'error'); return; }
                addToOutput(`üõ†Ô∏è Recover: ${data.updated_jobs} jobs, ${data.reset_targets} targets reset`,'success');
            } catch(e){ addToOutput(`‚ùå Network error (recover): ${e.message}`,'error'); }
        }

        const jobJsonWrapper = document.getElementById('job-json-wrapper');
        const jobJsonCode = document.getElementById('job-json-code');
        const jobJsonCopyBtn = document.getElementById('job-json-copy');
        const jobJsonCollapseBtn = document.getElementById('job-json-collapse');
        let jobJsonCollapsed = false;

        jobJsonCopyBtn?.addEventListener('click', () => {
            try { navigator.clipboard.writeText(jobJsonCode.textContent||''); addToOutput('üìã JSON copied','success'); } catch(e){ addToOutput('‚ùå Copy error','error'); }
        });
        jobJsonCollapseBtn?.addEventListener('click', () => {
            jobJsonCollapsed = !jobJsonCollapsed;
            if(jobJsonCollapsed){ jobJsonCode.style.display='none'; jobJsonCollapseBtn.textContent='Show'; }
            else { jobJsonCode.style.display='block'; jobJsonCollapseBtn.textContent='Hide'; }
        });

        function showRawJob(job){
            if(!job) return;
            const clone = {...job};
            jobJsonCode.textContent = JSON.stringify(clone, null, 2);
            jobJsonWrapper.classList.remove('hidden');
        }
        function showJobDetails(job){
            if(!job) return;
            showRawJob(job);
            if(job.id){ jobIdInput.value = job.id; selectedJobId = job.id; rememberJob(job.id); renderRecentJobs(); }
        }
        window.controlJob = async function(action, id){
            let path;
            switch(action){
                case 'status': path = `/status/${id}`; break;
                case 'pause': path = `/pause/${id}`; break;
                case 'resume': path = `/resume/${id}`; break;
                case 'cancel': path = `/cancel/${id}`; break;
                case 'retry': path = `/retry/${id}`; break;
                default: return;
            }
            try {
                addToOutput(`üîó ${action.toUpperCase()} request: ${id}`, 'info');
                const res = await fetch(API_BASE + path);
                const data = await res.json();
                if(!res.ok){ addToOutput(`‚ùå Error: ${data.error||'unknown'}`,'error'); return; }
                if(action==='status') { addToOutput(`üìÑ Status: ${data.status} (${data.id})`,'info'); showJobDetails(data); }
                else { addToOutput(`‚úÖ ${action.toUpperCase()} applied: ${data.status}`,'success'); showJobDetails(data); }
                showRawJob(data);
                if(data.id) { rememberJob(data.id); selectedJobId = data.id; renderRecentJobs(); }
            } catch(e){ addToOutput(`‚ùå Network error (${action}): ${e.message}`,'error'); }
        };
    </script>
</body>
</html>
